{% extends 'base.html' %}
{% load static %}

{% block head %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="{% static 'ckeditor/ckeditor/ckeditor.js' %}"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    /* Customize the CKEditor container */
    .cke_editable {
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        font-size: 16px;
    }

    .cke_chrome {
        border: 1px solid #ced4da !important;
        border-radius: 0.25rem !important;
    }

    #editor-container {
        margin-bottom: 1rem;
    }
    
    /* 标签选择器样式 */
    .select2-container--default .select2-selection--multiple {
        border: 1px solid #ced4da;
    }

    .select2-container--default.select2-container--focus .select2-selection--multiple {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
</style>
{% endblock %}

{% block main %}
<div class="ask-question-container">
    <div class="row">
        {% if expert %}
        <div class="col-md-4">
            <div class="expert-profile-card p-4 mb-4">
                <div class="text-center mb-4">
                    <div class="expert-avatar-lg mb-3">
                        {% if expert.avatar %}
                        <img src="{{ expert.avatar.url }}" alt="{{ expert.user.username }}" class="rounded-circle">
                        {% else %}
                        <i class="fas fa-user-tie fa-4x"></i>
                        {% endif %}
                    </div>
                    
                    <h4 class="mb-1">{{ expert.user.username }}</h4>
                    <!-- 暂时注释掉 title 字段显示，直到迁移完成 -->
                    {% comment %}
                    {% if expert.title %}
                    <p class="text-muted mb-1">{{ expert.title }}</p>
                    {% endif %}
                    {% endcomment %}
                    
                    <div class="expert-rating mb-2">
                        {% with ''|center:5 as range %}
                        {% for _ in range %}
                            {% if forloop.counter <= expert.rating %}
                                <i class="fas fa-star"></i>
                            {% else %}
                                <i class="far fa-star"></i>
                            {% endif %}
                        {% endfor %}
                        {% endwith %}
                        <span class="ms-2">({{ expert.rating|floatformat:1 }})</span>
                    </div>
                    
                    <div class="d-flex justify-content-center mb-3">
                        <span class="category-badge">{{ expert.get_category_display }}</span>
                    </div>
                </div>
                
                <div class="expert-bio mb-4">
                    <h5>专家简介</h5>
                    <p>{{ expert.bio }}</p>
                </div>
                
                <div class="text-center">
                    <a href="{% url 'expert_qa:expert_detail' expert.id %}" class="btn btn-outline-primary">
                        查看专家详情
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
        {% else %}
        <div class="col-md-12">
        {% endif %}
            <div class="card">
                <div class="card-header">
                    <h3>
                        {% if expert %}
                        向 {{ expert.user.username }} 提问
                        {% else %}
                        提出新问题
                        {% endif %}
                    </h3>
                </div>
                
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="title" class="form-label">问题标题</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                            <div class="form-text">请简明扼要地描述您的问题</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editor" class="form-label">问题详情</label>
                            <div id="editor-container">
                                <textarea id="editor" name="content" required></textarea>
                            </div>
                            <div class="form-text">详细描述您的问题，包括您已经尝试过的解决方法</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="category" class="form-label">问题类别</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="" selected disabled>请选择问题类别</option>
                                {% for code, name in categories %}
                                <option value="{{ code }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="tags" class="form-label">标签</label>
                            <select id="tags" name="tags" class="form-control" multiple="multiple">
                            </select>
                            <div class="form-text">添加标签，使您的问题更容易被搜索到（可选，多个标签用逗号分隔）</div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">提交问题</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // 初始化标签选择器
    $('#tags').select2({
        tags: true,
        tokenSeparators: [',', ' '],
        placeholder: '输入标签...',
        allowClear: true
    });

    // 初始化CKEditor
    const editor = CKEDITOR.replace('editor', {
        versionCheck: false,
        extraPlugins: 'image2',
        removePlugins: 'image',
        height: '400px',
        width: '100%',
        filebrowserImageUploadUrl: "{% url 'ckeditor_upload' %}",
        filebrowserUploadMethod: 'formdata',
        toolbar: [
            { name: 'document', items: ['Source'] },
            { name: 'clipboard', items: ['Cut', 'Copy', 'Paste', 'Undo', 'Redo'] },
            { name: 'editing', items: ['Find', 'Replace', 'SelectAll'] },
            { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript'] },
            { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
            { name: 'links', items: ['Link', 'Unlink'] },
            { name: 'insert', items: ['Image', 'Table', 'HorizontalRule', 'Smiley'] },
            { name: 'styles', items: ['Styles', 'Format', 'Font', 'FontSize'] }
        ]
    });

    // 表单提交时同步编辑器内容
    document.querySelector('form').addEventListener('submit', function() {
        editor.updateElement();
    });
});
</script>
{% endblock %}